name: Zuri Whiteboard Deployment Pipeline

on:
  # Triggers the workflow on push or pull request events but only for the main branch
  push:
    branches: [develop, main]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    name: yarn build
    steps:
      - uses: actions/checkout@v2

      - name: Install yarn dependencies and build project
        run: |
          cd whiteboard-server
          yarn install
          yarn build

      - name: Deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.ZURI_MAIN_HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          script: |
            cd /var/www/zc_plugin_whiteboard/
            git stash
            git pull origin develop
            cd whiteboard-server
            yarn install

      - name: Copy App dist folder to server
        uses: Creepios/sftp-action@v1.0.1
        with:
          host: ${{ secrets.ZURI_MAIN_HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          localPath: "./whiteboard-client/dist/"
          remotePath: "/var/www/zc_plugin_chessboard/whiteboard-client/dist"

      - name: Copy Root SPA dist folder to server
        uses: Creepios/sftp-action@v1.0.1
        with:
          host: ${{ secrets.ZURI_MAIN_HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          localPath: "./spa-root/dist/"
          remotePath: "/var/www/zc_plugin_chessboard/spa-root/dist"

      - name: Restart PM2 Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.ZURI_MAIN_HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          script: |
            cd /var/www/zc_plugin_whiteboard/
            pm2 restart whiteboard
